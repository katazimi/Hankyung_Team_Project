<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>AlgoView - ìì‚°ë°°ë¶„ ë¶„ì„</title>
    <link type="text/css" th:href="@{/css/main.css}" rel="stylesheet">
    <link type="text/css" th:href="@{/css/chart.css}" rel="stylesheet">
     <link type="text/css" th:href="@{/css/backtest.css}" rel="stylesheet">
    <link rel="icon" type="image/png" th:href="@{/images/logo.png}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
    
    <header>
        <div class="header-content">
            <div class="logo"><a href="/">Algo-View</a></div>
            <nav class="nav-menu">
                <a href="/">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/chart">ì°¨íŠ¸ ë¶„ì„</a>
                <a href="backtest">ë°±í…ŒìŠ¤íŠ¸</a>
                <a href="/portfolio">í¬íŠ¸í´ë¦¬ì˜¤</a>
            </nav>
            <div class="user-actions">
                <button th:if="${#authentication.name == 'anonymousUser'}" class="btn-login" onclick="location.href='/user/login'">ë¡œê·¸ì¸</button>
                <th:block th:if="${#authentication.name != 'anonymousUser'}">
                    <span class="user-info" th:text="${#authentication.name} + 'ë‹˜'"></span>
                    <button class="btn-logout" onclick="location.href='/user/logout'">ë¡œê·¸ì•„ì›ƒ</button>
                </th:block>
            </div>
        </div>
    </header>

    <div class="split-layout">
        
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ›ï¸ í¬íŠ¸í´ë¦¬ì˜¤ ì„¤ì •</h3>
                <button class="btn-history" onclick="openHistoryModal()">ğŸ•’ ì§€ë‚œ ê¸°ë¡</button>
            </div>
            
            <div class="form-group" style="margin-bottom:15px;">
                <label class="form-label">ì´ˆê¸° íˆ¬ìê¸ˆ (ì›)</label>
                <input type="number" id="seedMoney" value="10000000" class="asset-input" style="width:100%;">
            </div>

            <div class="form-group" style="margin-bottom:15px;">
                <label class="form-label">ë¶„ì„ ê¸°ê°„</label>
                <select id="period" class="asset-input" style="width:100%;">
                    <option value="12">ìµœê·¼ 1ë…„</option>
                    <option value="36">ìµœê·¼ 3ë…„</option>
                    <option value="60">ìµœê·¼ 5ë…„</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom:20px;">
                <label class="form-label">ë²¤ì¹˜ë§ˆí¬ (ë¹„êµ ëŒ€ìƒ)</label>
                <select id="benchmark" class="asset-input" style="width:100%;">
                    <option value="">ì„ íƒ ì•ˆí•¨</option>
                    <option value="069500">KOSPI 200 (KODEX 200)</option>
                    <option value="229200">KOSDAQ 150 (KODEX ì½”ìŠ¤ë‹¥150)</option>
                    <option value="005930">ì‚¼ì„±ì „ì (ê°œë³„ì¢…ëª© ë¹„êµ)</option>
                </select>
            </div>

            <label class="form-label">ìì‚° êµ¬ì„± (ë¹„ì¤‘ %)</label>
            <div id="assetList"></div>
            
            <button class="btn-add-asset" onclick="openSearchModal()">+ ì¢…ëª© ê²€ìƒ‰ ë° ì¶”ê°€</button>
            
            <div style="text-align:right; font-size:13px; color:#666; margin-top:10px;">
                ë¹„ì¤‘ í•©ê³„: <span id="totalWeight" style="font-weight:bold;">0</span>%
            </div>

            <button class="btn-submit" onclick="runAnalysis()">Analyze Portfolio â–¶</button>
        </div>

        <div class="panel">
            <h3 style="border-bottom:2px solid #333; padding-bottom:10px; margin-bottom:20px;">ğŸ“Š Highlights</h3>
           
            <div class="highlight-section" style="display:flex; flex-direction:column; align-items:center; margin-bottom:20px;">
                    <div class="hs-title" style="width:100%; color:#333;">Allocation</div>
                    <div style="width: 100%; height: 220px; position:relative;">
                        <canvas id="donutChart"></canvas>
                    </div>
            </div>
            
            <div class="highlights-container">
                <div class="highlight-section">
                    <div class="hs-title" style="color:#2563eb;">Return (ìˆ˜ìµ)</div>
                    <table class="comp-table">
                        <thead><tr><th>Metric</th><th class="pf-color">Portfolio</th><th class="bm-color">Benchmark</th></tr></thead>
                        <tbody>
                            <tr><td>Final Balance</td><td id="resFinal">0</td><td id="bmFinal">-</td></tr>
                            <tr><td>Total Return</td><td id="resTotal">0.00%</td><td id="bmTotal">-</td></tr>
                            <tr><td>CAGR</td><td id="resCagr">0.00%</td><td id="bmCagr">-</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="highlight-section">
                    <div class="hs-title" style="color:#e11d48;">Risk (ìœ„í—˜)</div>
                    <table class="comp-table">
                        <thead><tr><th>Metric</th><th class="pf-color">Portfolio</th><th class="bm-color">Benchmark</th></tr></thead>
                        <tbody>
                            <tr><td>Stdev</td><td id="resVol">0.00%</td><td id="bmVol">-</td></tr>
                            <tr><td>Max Drawdown</td><td id="resMdd">0.00%</td><td id="bmMdd">-</td></tr>
                            <tr><td>Sharpe Ratio</td><td id="resSharpe">0.00</td><td id="bmSharpe">-</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <h4 style="margin-bottom:15px;">ğŸ“ˆ Growth Chart (Portfolio vs Benchmark)</h4>
            <div style="height: 350px;">
                <canvas id="allocChart"></canvas>
            </div>
        </div>
    </div>

    <div id="searchModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;">ì¢…ëª© ê²€ìƒ‰</h3>
                <span class="close-btn" onclick="closeSearchModal()">âœ•</span>
            </div>
            <div class="modal-body">
                <input type="text" id="modalSearchInput" class="search-input" placeholder="ì¢…ëª©ëª… ì…ë ¥ (ì˜ˆ: ì‚¼ì„±)" autocomplete="off">
                <ul id="modalSearchList" class="search-list"></ul>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;">ğŸ•’ ë‚˜ì˜ ë¶„ì„ ê¸°ë¡</h3>
                <span class="close-btn" onclick="closeHistoryModal()">âœ•</span>
            </div>
            <div class="modal-body">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ìì‚° êµ¬ì„±</th>
                            <th style="text-align:right;">ì´ˆê¸°ê¸ˆ</th>
                            <th style="text-align:right;">ìˆ˜ìµë¥ </th>
                            <th style="text-align:center;">ë¶ˆëŸ¬ì˜¤ê¸°</th>
                        </tr>
                    </thead>
                    <tbody id="historyList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    	let chartInstance = null; // ìˆ˜ìµë¥  ê³¡ì„  ì°¨íŠ¸
        let donutChartInstance = null; // ë„ë„› ì°¨íŠ¸

        let lineChart = null; // ìˆ˜ìµë¥  ê³¡ì„  ì°¨íŠ¸
        let donutChart = null; // ë„ë„› ì°¨íŠ¸
        
        document.addEventListener('DOMContentLoaded', () => {
            addAssetToTable('ì‚¼ì„±ì „ì', '005930', 50);
            addAssetToTable('SKí•˜ì´ë‹‰ìŠ¤', '000660', 50);
            updateTotalWeight();
            
            // ì´ˆê¸° ë„ë„› ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ê¸°ë³¸ê°’)
            updateDonutChart([{name:'ì‚¼ì„±ì „ì', weight:50}, {name:'SKí•˜ì´ë‹‰ìŠ¤', weight:50}]);
        });
        

        // ------------------------
        // ëª¨ë‹¬ ê³µí†µ í•¨ìˆ˜
        // ------------------------
        function openAnyModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            setTimeout(() => { modal.classList.add('show'); }, 10);
        }
        function closeAnyModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        // ------------------------
        // ìì‚° ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
        // ------------------------
        function addAssetToTable(name, code, weight = 0) {
            const div = document.createElement('div');
            div.className = 'asset-row';
            div.innerHTML = `
                <div class="asset-info">
                    ${name}
                    <span class="asset-code">${code}</span>
                    <input type="hidden" class="code-input" value="${code}">
                    <input type="hidden" class="name-input" value="${name}">
                </div>
                <input type="number" class="weight-input" value="${weight}" oninput="updateTotalWeight()" placeholder="%">
                <span style="font-size:14px; color:#666;">%</span>
                <button class="btn-remove" onclick="this.parentElement.remove(); updateTotalWeight();">Ã—</button>
            `;
            document.getElementById('assetList').appendChild(div);
            updateTotalWeight();
        }

        function updateTotalWeight() {
            let sum = 0;
            const currentAssets = [];
            document.querySelectorAll('.asset-row').forEach(row => {
                const w = Number(row.querySelector('.weight-input').value);
                const n = row.querySelector('.name-input').value;
                sum += w;
                if(w > 0) currentAssets.push({name: n, weight: w});
            });
            
            const span = document.getElementById('totalWeight');
            span.innerText = sum;
            span.style.color = sum === 100 ? '#2563eb' : '#e11d48';
            
            // ë¹„ì¤‘ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ë„ë„› ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ì„ íƒ ì‚¬í•­)
            // updateDonutChart(currentAssets); 
        }

        // ------------------------
        // ë¶„ì„ ì‹¤í–‰
        // ------------------------
        function runAnalysis() {
            const seed = document.getElementById('seedMoney').value;
            const period = document.getElementById('period').value;
            const benchmark = document.getElementById('benchmark').value;
            const rows = document.querySelectorAll('.asset-row');
            
            const assets = [];
            let weightSum = 0;

            rows.forEach(row => {
                const code = row.querySelector('.code-input').value;
                const name = row.querySelector('.name-input').value;
                const weight = Number(row.querySelector('.weight-input').value);
                
                if(weight > 0) {
                    assets.push({ code: code, name: name, weight: weight });
                    weightSum += weight;
                }
            });

            if(assets.length === 0) { alert("ì¢…ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”."); return; }
            if(weightSum !== 100) { alert("ë¹„ì¤‘ í•©ê³„ëŠ” 100%ì—¬ì•¼ í•©ë‹ˆë‹¤."); return; }

            const req = { seedMoney: seed, periodMonths: period, assets: assets, benchmarkCode: benchmark };
            document.querySelector('.btn-submit').innerText = "ë¶„ì„ ì¤‘...";

            fetch('/api/allocation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(req)
            })
            .then(res => res.json())
            .then(data => {
                renderResult(data);
                updateDonutChart(assets); // ë¶„ì„ ì‹¤í–‰ ì‹œ ë„ë„› ì°¨íŠ¸ ê°±ì‹ 
            })
            .catch(err => alert("ë¶„ì„ ì‹¤íŒ¨: " + err))
            .finally(() => { document.querySelector('.btn-submit').innerText = "Analyze Portfolio â–¶"; });
        }

        function renderResult(data) {
            // Portfolio ê°’ ì±„ìš°ê¸°
            document.getElementById('resFinal').innerText = Math.round(data.finalBalance).toLocaleString();
            document.getElementById('resTotal').innerText = data.totalReturn + "%";
            document.getElementById('resCagr').innerText = data.cagr + "%";
            document.getElementById('resVol').innerText = data.volatility + "%";
            document.getElementById('resMdd').innerText = data.mdd + "%";
            document.getElementById('resSharpe').innerText = data.sharpeRatio;

            // Benchmark ê°’ ì±„ìš°ê¸° (ë°ì´í„° ì—†ìœ¼ë©´ '-')
            const hasBm = data.bmFinalBalance > 0;
            document.getElementById('bmFinal').innerText = hasBm ? Math.round(data.bmFinalBalance).toLocaleString() : '-';
            document.getElementById('bmTotal').innerText = hasBm ? data.bmTotalReturn + "%" : '-';
            document.getElementById('bmCagr').innerText = hasBm ? data.bmCagr + "%" : '-';
            document.getElementById('bmVol').innerText = hasBm ? data.bmVolatility + "%" : '-';
            document.getElementById('bmMdd').innerText = hasBm ? data.bmMdd + "%" : '-';
            document.getElementById('bmSharpe').innerText = hasBm ? data.bmSharpeRatio : '-';

            // Chart ê·¸ë¦¬ê¸° (ë°ì´í„°ì…‹ 2ê°œ)
            const ctx = document.getElementById('allocChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            const datasets = [{
                label: 'Portfolio',
                data: data.equityCurve.map(d => d.value),
                borderColor: '#2563eb', // íŒŒë‘
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                fill: true, pointRadius: 0, borderWidth: 2
            }];

            // ë²¤ì¹˜ë§ˆí¬ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì°¨íŠ¸ì— ì¶”ê°€
            if (hasBm && data.bmEquityCurve) {
                datasets.push({
                    label: 'Benchmark',
                    data: data.bmEquityCurve.map(d => d.value),
                    borderColor: '#e11d48', // ë¹¨ê°•
                    borderDash: [5, 5], // ì ì„ 
                    backgroundColor: 'transparent',
                    fill: false, pointRadius: 0, borderWidth: 2
                });
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.equityCurve.map(d => d.date),
                    datasets: datasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ": " + Number(ctx.raw).toLocaleString() + " ì›" } } },
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: false } }
                }
            });
        }

        // ë„ë„› ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateDonutChart(assets) {
            const ctx = document.getElementById('donutChart').getContext('2d');
            if(donutChartInstance) donutChartInstance.destroy();

            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'];

            donutChartInstance = new Chart(ctx, {
                type: 'doughnut',
                plugins: [ChartDataLabels], // í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”
                data: {
                    labels: assets.map(a => a.name),
                    datasets: [{
                        data: assets.map(a => a.weight),
                        backgroundColor: colors.slice(0, assets.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'right', // ë²”ë¡€ í•˜ë‹¨ ë°°ì¹˜
                            align: 'start',
                            labels: { boxWidth: 10, font: { size: 11 }, padding: 10 }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value) => value >= 5 ? value + '%' : '' // 5% ë¯¸ë§Œì€ ìˆ¨ê¹€
                        },
                        tooltip: { callbacks: { label: (ctx) => ` ${ctx.label}: ${ctx.raw}%` } }
                    },
                    cutout: '60%',
                    layout: { padding: 10 }
                }
            });
        }

        // ------------------------
        // ëª¨ë‹¬ ê¸°ëŠ¥ (ê²€ìƒ‰ & ê¸°ë¡)
        // ------------------------
        function openSearchModal() {
            document.getElementById('modalSearchInput').value = '';
            document.getElementById('modalSearchList').style.display = 'none';
            openAnyModal('searchModal');
            setTimeout(() => document.getElementById('modalSearchInput').focus(), 100);
        }
        function closeSearchModal() { closeAnyModal('searchModal'); }

        document.getElementById('modalSearchInput').addEventListener('keyup', function() {
            const keyword = this.value.trim();
            const list = document.getElementById('modalSearchList');
            if(keyword.length < 1) { list.style.display = 'none'; return; }

            fetch(`/api/stock/search?keyword=${keyword}`)
                .then(res => res.json())
                .then(data => {
                    list.innerHTML = '';
                    if(data.length > 0) {
                        list.style.display = 'block';
                        data.forEach(stock => {
                            const li = document.createElement('li');
                            li.innerHTML = `${stock.name} <span style="color:#999; font-size:12px;">${stock.code}</span>`;
                            li.onclick = () => {
                            	ensureStockDataForBacktest(stock.code, stock.name);
                                addAssetToTable(stock.name, stock.code, 0); 
                                closeSearchModal();
                            };
                            list.appendChild(li);
                        });
                    } else { list.style.display = 'none'; }
                });
        });

        function openHistoryModal() {
            fetch('/api/allocation/history')
                .then(res => {
                    if (res.status === 401) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return null; }
                    return res.json();
                })
                .then(list => {
                    if(!list) return;
                    const tbody = document.getElementById('historyList');
                    tbody.innerHTML = '';
                    openAnyModal('historyModal');

                    if (list.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                        return;
                    }

                    list.forEach(item => {
                        const row = document.createElement('tr');
                        const profitClass = item.totalReturn > 0 ? 'up' : 'down';
                        const jsonStr = item.assetsJson.replace(/"/g, '&quot;');

                        row.innerHTML = `
                            <td>${item.date}</td>
                            <td>${item.assetsSummary}</td>
                            <td style="text-align:right;">${item.seedMoney.toLocaleString()}</td>
                            <td style="text-align:right;" class="${profitClass}">${item.totalReturn}%</td>
                            <td style="text-align:center;">
                                <button class="btn-load" onclick="restoreSettings('${item.seedMoney}', '${item.periodMonths}', '${jsonStr}')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                });
        }
        function closeHistoryModal() { closeAnyModal('historyModal'); }

        function restoreSettings(seed, period, assetsJson) {
            if (!confirm("ì„¤ì •ê°’ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            document.getElementById('seedMoney').value = seed;
            document.getElementById('period').value = period;
            document.getElementById('assetList').innerHTML = '';
            
            const assets = JSON.parse(assetsJson.replace(/&quot;/g, '"'));
            assets.forEach(a => addAssetToTable(a.name, a.code, a.weight));
            updateTotalWeight();
            updateDonutChart(assets); // ë„ë„› ì°¨íŠ¸ë„ ë³µì›ëœ ê°’ìœ¼ë¡œ ê°±ì‹ 
            closeHistoryModal();
        }

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('show');
                setTimeout(() => { e.target.style.display = 'none'; }, 300);
            }
        });
        
        //modal ê²€ìƒ‰ í›„ ë°ì´í„° í™•ì¸ ë° ìˆ˜ì§‘
        function ensureStockDataForBacktest(code, name) {
		    fetch(`/api/stock/${code}/candle-data?type=D`)
		        .then(res => res.json())
		        .then(data => {
		            if (!Array.isArray(data) || data.length === 0) {
		                if (confirm(`[${name}] ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\në°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
		                    collectDataForBacktest(code, name);
		                }
		            }
		        })
		        .catch(err => console.error(err));
		}
		
        function collectDataForBacktest(code, name) {
            alert("ìˆ˜ì§‘ ì‹œì‘...");
            fetch(`/api/collect/${code}`).then(() => {
                let checkInterval = setInterval(() => {
                    fetch(`/api/stock/${code}/candle-data?type=D`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.length > 100) {   // ì„ì‹œ ì™„ë£Œ ê¸°ì¤€
                                clearInterval(checkInterval);
                                alert(`[${name}] ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!`);
                                // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ backtest ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ
                                // startBacktest(code, name);
                            }
                        });
                }, 3000);
            });
        }
    </script>
</body>
</html>