<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ì‹ ì°¨íŠ¸</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 25px;
            box-sizing: border-box;
        }
        
        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ (ê²€ìƒ‰ + ì£¼ê¸° ë²„íŠ¼) */
        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-wrapper { position: relative; flex: 1; max-width: 400px; }
        #searchInput { width: 100%; padding: 12px 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        #searchResult { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; list-style: none; padding: 0; margin: 0; z-index: 1000; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #searchResult li { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        #searchResult li:hover { background-color: #f8f9fa; color: #2962FF; }

        /* â­ï¸ ì£¼ê¸° ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .period-selector { display: flex; gap: 5px; }
        .period-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background-color: white;
            color: #555;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        .period-btn:hover { background-color: #f1f3f5; }
        .period-btn.active {
            background-color: #2962FF;
            color: white;
            border-color: #2962FF;
        }
        
        .favorite-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background-color: white;
            color: #555;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        .favorite-btn.active {
    		background-color: #ffc107;
    		color: #ffffff;
		}
		.favorite-btn:hover {
    		filter: brightness(0.97);
		}

        /* ì •ë³´ í‘œì‹œì¤„ */
        #chartLegend {
            width: 100%; min-height: 54px; margin-bottom: 15px; padding: 12px 20px;
            background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;
            box-sizing: border-box; display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
            font-size: 14px; color: #495057;
        }
        .stock-title { font-size: 22px; font-weight: 800; margin-right: 10px; color: #212529; }
        .legend-item { display: flex; align-items: center; }
        .legend-label { margin-right: 6px; color: #868e96; font-size: 13px; }
        .legend-value { font-weight: 600; font-size: 15px; }
        .up { color: #e11d48; } .down { color: #2563eb; }

        /* ì°¨íŠ¸ */
        #tv_chart { width: 100%; height: 550px; border-radius: 4px; overflow: hidden; }

        /* ë¶„ì„ ì˜ì—­ */
        #analysisSection { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; display: none; }
        .analysis-header { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; }
        .analysis-header::before { content: ''; display: inline-block; width: 4px; height: 18px; background: #2962FF; margin-right: 10px; border-radius: 2px; }
        
        .pattern-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .pattern-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: transform 0.2s; }
        .pattern-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #2962FF; }
        .pattern-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pattern-name { font-size: 16px; font-weight: bold; color: #333; }
        .trend-badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .trend-up { background-color: #ffebee; color: #c62828; }
        .trend-down { background-color: #e3f2fd; color: #1565c0; }
        .trend-neutral { background-color: #f5f5f5; color: #616161; }
        .pattern-desc { font-size: 13px; color: #666; line-height: 1.5; margin-bottom: 10px; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .pattern-meta { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 10px; font-size: 12px; color: #999; }
        .reliability-stars { color: #ffc107; letter-spacing: 1px; }
    </style>
</head>
<body>
	<input type="hidden" id="currentUserId" th:value="${userId}">

    <div class="container">
        <!-- ì»¨íŠ¸ë¡¤ ë°” -->
        <div class="control-bar">
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì‚¼ì„±ì „ì)" autocomplete="off">
                <ul id="searchResult"></ul>
            </div>
            
            <!-- â­ï¸ ì£¼ê¸° ì„ íƒ ë²„íŠ¼ -->
            <div class="period-selector">
                <button class="period-btn active" onclick="changePeriod('D')">ì¼ë´‰</button>
                <button class="period-btn" onclick="changePeriod('W')">ì£¼ë´‰</button>
                <button class="period-btn" onclick="changePeriod('M')">ì›”ë´‰</button>
                <button class="favorite-btn" onclick="toggleFavorite()">â˜† ì¦ê²¨ì°¾ê¸°</button>
            </div>
        </div>

        <!-- ì •ë³´ í‘œì‹œì¤„ -->
        <div id="chartLegend">
            <span class="stock-title">ì‚¼ì„±ì „ì (005930)</span>
        </div>

        <!-- ì°¨íŠ¸ -->
        <div id="tv_chart"></div>

        <!-- â­ï¸ íŒ¨í„´ ë¶„ì„ ê²°ê³¼ ì˜ì—­ -->
        <div id="analysisSection">
            <div class="analysis-header" id="analysisHeader">ğŸ“Š ì¼ë´‰ ê¸°ì¤€ ìº”ë“¤ íŒ¨í„´ ë¶„ì„</div>
            <div id="patternList" class="pattern-list"></div>
        </div>
    </div>

    <script>
        const PATTERN_DEFINITIONS = {
            "HAMMER": { name: "ë§ì¹˜í˜•", desc: "í•˜ë½ ì¶”ì„¸ ë°”ë‹¥ì—ì„œ ë°œìƒí•˜ë©° ìƒìŠ¹ ë°˜ì „ì„ ì˜ˆê³ í•©ë‹ˆë‹¤.", trend: "ìƒìŠ¹", stars: 3 },
            "INVERTED_HAMMER": { name: "ì—­ë§ì¹˜í˜•", desc: "ë°”ë‹¥ê¶Œì—ì„œ ë§¤ìˆ˜ì„¸ê°€ ìœ ì…ë˜ë ¤ëŠ” ì‹ í˜¸ì…ë‹ˆë‹¤.", trend: "ìƒìŠ¹", stars: 2 },
            "BULLISH_ENGULFING": { name: "ìƒìŠ¹ ì¥ì•…í˜•", desc: "ì „ì¼ ìŒë´‰ì„ ì˜¤ëŠ˜ ì–‘ë´‰ì´ ê°ì‹¸ëŠ” ê°•ë ¥í•œ ìƒìŠ¹ ì‹ í˜¸ì…ë‹ˆë‹¤.", trend: "ìƒìŠ¹", stars: 5 },
            "MORNING_STAR": { name: "ìƒ›ë³„í˜•", desc: "í•˜ë½â†’ë„ì§€â†’ìƒìŠ¹ìœ¼ë¡œ ì´ì–´ì§€ëŠ” í™•ì‹¤í•œ ë°˜ì „ ì‹ í˜¸ì…ë‹ˆë‹¤.", trend: "ìƒìŠ¹", stars: 5 },
            "THREE_WHITE_SOLDIERS": { name: "ì ì‚¼ë³‘", desc: "ì–‘ë´‰ 3ê°œê°€ ì—°ì† ìƒìŠ¹í•˜ë©° ì¶”ì„¸ ì§€ì†ì„ ì•Œë¦½ë‹ˆë‹¤.", trend: "ìƒìŠ¹", stars: 4 },
            "SHOOTING_STAR": { name: "ìœ ì„±í˜•", desc: "ê³ ì ì—ì„œ ê¸´ ìœ„ê¼¬ë¦¬ê°€ ë°œìƒí•˜ë©° í•˜ë½ ë°˜ì „ì„ ì˜ˆê³ í•©ë‹ˆë‹¤.", trend: "í•˜ë½", stars: 3 },
            "HANGING_MAN": { name: "êµìˆ˜í˜•", desc: "ê³ ì ì—ì„œ ë§¤ë„ì„¸ê°€ ì¶œí˜„í–ˆìŒì„ ì•Œë¦½ë‹ˆë‹¤.", trend: "í•˜ë½", stars: 2 },
            "BEARISH_ENGULFING": { name: "í•˜ë½ ì¥ì•…í˜•", desc: "ì „ì¼ ì–‘ë´‰ì„ ì˜¤ëŠ˜ ìŒë´‰ì´ ê°ì‹¸ëŠ” ê°•ë ¥í•œ í•˜ë½ ì‹ í˜¸ì…ë‹ˆë‹¤.", trend: "í•˜ë½", stars: 5 },
            "EVENING_STAR": { name: "ì„ë³„í˜•", desc: "ìƒìŠ¹â†’ë„ì§€â†’í•˜ë½ìœ¼ë¡œ ì´ì–´ì§€ëŠ” í™•ì‹¤í•œ í•˜ë½ ì‹ í˜¸ì…ë‹ˆë‹¤.", trend: "í•˜ë½", stars: 5 },
            "THREE_BLACK_CROWS": { name: "í‘ì‚¼ë³‘", desc: "ìŒë´‰ 3ê°œê°€ ì—°ì† í•˜ë½í•˜ë©° ì¶”ì„¸ ì§€ì†ì„ ì•Œë¦½ë‹ˆë‹¤.", trend: "í•˜ë½", stars: 4 },
            "DOJI": { name: "ë„ì§€í˜•", desc: "ì‹œê°€ì™€ ì¢…ê°€ê°€ ì¼ì¹˜í•˜ë©° ì¶”ì„¸ ì „í™˜ì˜ ì „ì¡°ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", trend: "ì¤‘ë¦½", stars: 1 },
            "SPINNING_TOP": { name: "íŒ½ì´í˜•", desc: "ë°©í–¥ì„±ì´ ê²°ì •ë˜ì§€ ì•Šì€ ì¤‘ë¦½ ìƒíƒœì…ë‹ˆë‹¤.", trend: "ì¤‘ë¦½", stars: 1 },
            "NONE": { name: "íŠ¹ì´ íŒ¨í„´ ì—†ìŒ", desc: "í˜„ì¬ ë¶„ì„ëœ ëšœë ·í•œ ìº”ë“¤ íŒ¨í„´ì´ ì—†ìŠµë‹ˆë‹¤.", trend: "ì¤‘ë¦½", stars: 0 }
        };

        // ì „ì—­ ë³€ìˆ˜
        let currentCode = "005930";
        let currentName = "ì‚¼ì„±ì „ì";
        let currentPeriod = "D"; // ê¸°ë³¸ ì¼ë´‰
        let allData = [];
        let isLoading = false;
        
        // ì°¨íŠ¸ ê°ì²´
        let chart, candleSeries, ma5Series, ma20Series, ma60Series, volumeSeries;
        
        //í˜„ì¬ ì¢…ëª© ì¦ê²¨ì°¾ê¸° ì—¬ë¶€
        let isFavorite = false;

        document.addEventListener('DOMContentLoaded', function () {
            initChart();
            loadDataAndAnalysis(); // ì´ˆê¸° ì‹¤í–‰
        });

        function initChart() {
            const chartContainer = document.getElementById('tv_chart');
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth, height: 550,
                layout: { backgroundColor: '#ffffff', textColor: '#333', fontFamily: 'Pretendard, sans-serif' },
                grid: { vertLines: { color: '#f0f3fa' }, horzLines: { color: '#f0f3fa' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal, vertLine: { labelVisible: false }, horzLine: { labelVisible: false } },
                rightPriceScale: { visible: true, borderColor: '#e0e0e0', scaleMargins: { top: 0.05, bottom: 0.30 } },
                timeScale: { rightOffset: 12, barSpacing: 10, timeVisible: true, secondsVisible: false, borderColor: '#e0e0e0' },
            });

            candleSeries = chart.addCandlestickSeries({ upColor: '#e11d48', borderUpColor: '#e11d48', wickUpColor: '#e11d48', downColor: '#2563eb', borderDownColor: '#2563eb', wickDownColor: '#2563eb', lastValueVisible: false, priceLineVisible: false });
            ma5Series = chart.addLineSeries({ color: '#2962FF', lineWidth: 1, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            ma20Series = chart.addLineSeries({ color: '#B71C1C', lineWidth: 2, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            ma60Series = chart.addLineSeries({ color: '#00C853', lineWidth: 2, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            volumeSeries = chart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: 'vol_scale', lastValueVisible: false, priceLineVisible: false });
            
            chart.priceScale('vol_scale').applyOptions({ scaleMargins: { top: 0.75, bottom: 0 } });
            chart.subscribeCrosshairMove(updateLegend);
            
            window.addEventListener('resize', () => chart.resize(chartContainer.clientWidth, 550));
        }

        // â­ï¸ ì£¼ê¸° ë³€ê²½ í•¨ìˆ˜ (ë²„íŠ¼ í´ë¦­ ì‹œ)
        window.changePeriod = function(period) {
            if (currentPeriod === period) return;
            currentPeriod = period;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // ì°¨íŠ¸ ë° ë¶„ì„ í—¤ë” ì—…ë°ì´íŠ¸
            const pText = period === 'D' ? 'ì¼ë´‰' : (period === 'W' ? 'ì£¼ë´‰' : 'ì›”ë´‰');
            document.getElementById('analysisHeader').textContent = `ğŸ“Š ${pText} ê¸°ì¤€ ìº”ë“¤ íŒ¨í„´ ë¶„ì„`;

            // ë°ì´í„° ì¬ë¡œë”©
            allData = [];
            candleSeries.setData([]); ma5Series.setData([]); ma20Series.setData([]); ma60Series.setData([]); volumeSeries.setData([]);
            loadDataAndAnalysis();
        };

        // â­ï¸ í†µí•© ë°ì´í„° ë¡œë”© (ì°¨íŠ¸ + ë¶„ì„)
        function loadDataAndAnalysis() {
            if (isLoading) return; isLoading = true;
            
            // ì°¨íŠ¸ ë°ì´í„° ìš”ì²­ (type íŒŒë¼ë¯¸í„° ì¶”ê°€)
            fetch(`/api/stock/${currentCode}/candle-data?type=${currentPeriod}`)
                .then(res => res.json())
                .then(data => {
                	if (!Array.isArray(data) || data.length === 0) {
                	    // ì¡°ê±´ ì œê±°: if (currentPeriod === 'D')  <-- ì‚­ì œë¨
                	    if (confirm(`[${currentName}] ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\në°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                	        collectData(currentCode);
                	    }
                	    isLoading = false; 
                	    return;
                	}
                    
                    allData = data;
                    updateChartSeries(allData);
                    updateLegend({ time: null, point: { x: -1, y: -1 } });
                    
                    // ì°¨íŠ¸ ë¡œë”© ì™„ë£Œ í›„ ë¶„ì„ ë°ì´í„° ìš”ì²­ (type íŒŒë¼ë¯¸í„° ì‚¬ìš©)
                    loadAnalysisData(); 
                    isLoading = false;
                })
                .catch(err => { console.error(err); isLoading = false; });
        }

        // â­ï¸ ë¶„ì„ ë°ì´í„° ë¡œë”©
        function loadAnalysisData() {
            const listDiv = document.getElementById('patternList');
            const section = document.getElementById('analysisSection');
            listDiv.innerHTML = ''; section.style.display = 'none';

            fetch(`/api/stock/${currentCode}/analysis?type=${currentPeriod}`)
                .then(res => res.json())
                .then(list => {
                    section.style.display = 'block';
                    if (!list || list.length === 0 || (list.length === 1 && list[0].type === 'NONE')) {
                        listDiv.innerHTML = `<div style="color:#999; padding:10px;">ë°œê²¬ëœ íŠ¹ì´ íŒ¨í„´ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                        return;
                    }
                    list.forEach(item => {
                        const def = PATTERN_DEFINITIONS[item.type] || PATTERN_DEFINITIONS["NONE"];
                        let badgeClass = 'trend-neutral';
                        let trendIcon = '-';
                        if (def.trend === 'ìƒìŠ¹') { badgeClass = 'trend-up'; trendIcon = 'â–² ìƒìŠ¹'; }
                        else if (def.trend === 'í•˜ë½') { badgeClass = 'trend-down'; trendIcon = 'â–¼ í•˜ë½'; }
                        
                        const stars = 'â˜…'.repeat(def.stars) + 'â˜†'.repeat(5 - def.stars);
                        const cardHtml = `
                            <div class="pattern-card">
                                <div class="pattern-top">
                                    <span class="pattern-name">${def.name}</span>
                                    <span class="trend-badge ${badgeClass}">${trendIcon}</span>
                                </div>
                                <div class="pattern-desc">${def.desc}</div>
                                <div class="pattern-meta">
                                    <span>ë°œìƒì¼: ${item.date}</span>
                                    <span class="reliability-stars">${stars}</span>
                                </div>
                            </div>`;
                        listDiv.insertAdjacentHTML('beforeend', cardHtml);
                    });
                });
        }

        function updateChartSeries(dataList) {
            const candles = dataList.map(d => ({ time: d.x, open: d.y[0], high: d.y[1], low: d.y[2], close: d.y[3] }));
            const ma5 = dataList.map(d => ({ time: d.x, value: d.ma5 })).filter(d => d.value);
            const ma20 = dataList.map(d => ({ time: d.x, value: d.ma20 })).filter(d => d.value);
            const ma60 = dataList.map(d => ({ time: d.x, value: d.ma60 })).filter(d => d.value);
            const volumes = dataList.map(d => ({ time: d.x, value: d.volume, color: (d.y[3] >= d.y[0]) ? 'rgba(225, 29, 72, 0.5)' : 'rgba(37, 99, 235, 0.5)' }));

            candleSeries.setData(candles); ma5Series.setData(ma5); ma20Series.setData(ma20); ma60Series.setData(ma60); volumeSeries.setData(volumes);
        }

        function updateLegend(param) {
            const valid = (param.time && param.point.x >= 0 && param.point.x <= chartContainer.clientWidth && param.point.y >= 0 && param.point.y <= chartContainer.clientHeight);
            const data = valid ? param.seriesData.get(candleSeries) : (allData.length > 0 ? allData[allData.length - 1] : null);
            const ma5 = valid ? param.seriesData.get(ma5Series) : (allData.length > 0 ? allData[allData.length - 1]?.ma5 : null);
            const ma20 = valid ? param.seriesData.get(ma20Series) : (allData.length > 0 ? allData[allData.length - 1]?.ma20 : null);
            const ma60 = valid ? param.seriesData.get(ma60Series) : (allData.length > 0 ? allData[allData.length - 1]?.ma60 : null);

            const container = document.getElementById('chartLegend');
            let html = `<span class="stock-title">${currentName} (${currentCode})</span>`;

            if (data) {
                const open = (data.open || data.y?.[0] || 0);
                const high = (data.high || data.y?.[1] || 0);
                const low = (data.low || data.y?.[2] || 0);
                const close = (data.close || data.y?.[3] || 0);
                const colorClass = (close >= open) ? 'up' : 'down';

                html += `<div class="legend-item"><span class="legend-label">ì‹œ</span><span class="legend-value ${colorClass}">${Number(open).toLocaleString()}</span></div>
                         <div class="legend-item"><span class="legend-label">ê³ </span><span class="legend-value ${colorClass}">${Number(high).toLocaleString()}</span></div>
                         <div class="legend-item"><span class="legend-label">ì €</span><span class="legend-value ${colorClass}">${Number(low).toLocaleString()}</span></div>
                         <div class="legend-item"><span class="legend-label">ì¢…</span><span class="legend-value ${colorClass}">${Number(close).toLocaleString()}</span></div>`;
            }
            
            const getVal = (obj) => (obj && typeof obj === 'object' && 'value' in obj) ? obj.value : obj;
            if (getVal(ma5)) html += `<div class="legend-item" style="color: #2962FF;"><span class="legend-label">MA5</span><span class="legend-value">${Math.round(getVal(ma5)).toLocaleString()}</span></div>`;
            if (getVal(ma20)) html += `<div class="legend-item" style="color: #B71C1C;"><span class="legend-label">MA20</span><span class="legend-value">${Math.round(getVal(ma20)).toLocaleString()}</span></div>`;
            if (getVal(ma60)) html += `<div class="legend-item" style="color: #00C853;"><span class="legend-label">MA60</span><span class="legend-value">${Math.round(getVal(ma60)).toLocaleString()}</span></div>`;

            container.innerHTML = html;
        }

        // ê²€ìƒ‰, ìˆ˜ì§‘, ë¬´í•œìŠ¤í¬ë¡¤ ë“± ê¸°ì¡´ ë¡œì§ ìœ ì§€
        const searchInput = document.getElementById('searchInput');
        const searchResult = document.getElementById('searchResult');
        searchInput.addEventListener('keyup', function() {
            const keyword = this.value.trim();
            if (keyword.length < 1) { searchResult.style.display = 'none'; return; }
            fetch(`/api/stock/search?keyword=${keyword}`).then(res => res.json()).then(list => {
                searchResult.innerHTML = '';
                if (list.length > 0) {
                    searchResult.style.display = 'block';
                    list.forEach(stock => {
                        const li = document.createElement('li');
                        li.textContent = `${stock.name} (${stock.code})`;
                        li.onclick = () => selectStock(stock.code, stock.name);
                        searchResult.appendChild(li);
                    });
                } else { searchResult.style.display = 'none'; }
            });
        });

        function selectStock(code, name) {
            currentCode = code; currentName = name;
            searchInput.value = ''; searchResult.style.display = 'none';
            updateLegend({ time: null, point: { x: -1, y: -1 } });
            loadDataAndAnalysis();
        }

        function collectData(code) {
            alert("ìˆ˜ì§‘ ì‹œì‘...");
            fetch(`/api/collect/${code}`).then(() => {
                let checkInterval = setInterval(() => {
                    fetch(`/api/stock/${code}/candle-data?type=D`).then(res => res.json()).then(data => {
                        if(data.length > 100) { clearInterval(checkInterval); loadDataAndAnalysis(); }
                    });
                }, 3000);
            });
        }
        
        
        //ì´ˆê¸° ë°ì´í„° ë¡œë”© ì¢…ë£Œ í›„, í˜„ì¬ ì¢…ëª©ì´ ì¦ê²¨ì°¾ê¸° ë˜ì–´ìˆëŠ”ì§€ í™•ì¸
        function checkFavorite() {
    		const userId = document.getElementById('currentUserId')?.value;
    		if (!userId) return;

    		fetch(`/api/favorite/${userId}/${currentCode}`)
        		.then(res => res.json())
        		.then(flag => {
            		isFavorite = !!flag;
            		updateFavoriteButton();
        		});
		}

		function updateFavoriteButton() {
    		const btn = document.getElementById('favoriteBtn');
    		if (!btn) return;
    		if (isFavorite) {
        		btn.classList.add('active');
        		btn.textContent = 'â˜… ì¦ê²¨ì°¾ê¸°';
    		} else {
        		btn.classList.remove('active');
        		btn.textContent = 'â˜† ì¦ê²¨ì°¾ê¸°';
    		}
		}
		
		function toggleFavorite() {
		    const userId = document.getElementById('currentUserId')?.value;
		    if (!userId) {
		        alert('ë¡œê·¸ì¸ í›„ ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
		        return;
		    }

		    const method = isFavorite ? 'DELETE' : 'POST';
		    fetch('/api/favorite', {
		        method,
		        headers: { 'Content-Type': 'application/json' },
		        body: JSON.stringify({ userId, stockCode: currentCode })
		    })
		    .then(res => {
		        if (!res.ok) throw new Error('favorite fail');
		        isFavorite = !isFavorite;
		        updateFavoriteButton();
		    })
		    .catch(() => alert('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
		}
        
    </script>
</body>
</html>