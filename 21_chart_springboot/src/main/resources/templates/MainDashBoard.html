<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>AlgoView - ëŒ€ì‹œë³´ë“œ</title>
    <link type="text/css" th:href="@{/css/chart.css}" rel="stylesheet">
    <link type="text/css" th:href="@{/css/main.css}" rel="stylesheet">
    <link rel="icon" type="image/png" th:href="@{/images/logo.png}">
</head>
<body>

    <header>
        <div class="header-content">
            <div class="logo">
                <a href="/" style="vertical-align:middle;">Algo-View</a>
            </div>
            <nav class="nav-menu">
                <a href="/" class="active">ëŒ€ì‹œë³´ë“œ</a> <a href="/chart">ì°¨íŠ¸ ë¶„ì„</a>
                <a href="/backtest">ë°±í…ŒìŠ¤íŠ¸</a>
                <a href="/portfolio">í¬íŠ¸í´ë¦¬ì˜¤</a>
            </nav>
            <div class="user-actions">
                <button sec:authorize="isAnonymous()" class="btn-login" onclick="location.href='/user/login'">ë¡œê·¸ì¸</button>
                <button sec:authorize="isAnonymous()" class="btn-signup" onclick="location.href='/user/signUp'">íšŒì›ê°€ì…</button>
                <th:block sec:authorize="isAuthenticated()">
                    <span class="user-info"><span sec:authentication="name">User</span>ë‹˜</span>
                    <button class="btn-logout" onclick="location.href='/user/logout'">ë¡œê·¸ì•„ì›ƒ</button>
                </th:block>
            </div>
        </div>
    </header>

    <div class="wrapper">
        <section class="hero-section">
            <div class="hero-title">ì–´ë–¤ ì¢…ëª©ì„ ë¶„ì„í•´ ë“œë¦´ê¹Œìš”?</div>
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì‚¼ì„±ì „ì)" autocomplete="off">
                <ul id="searchResult"></ul>
            </div>
        </section>

        <section class="market-indices">
            <div class="index-card">
                <div class="index-name">KOSPI</div>
                <div id="kospi-price" class="index-value">-</div>
                <div id="kospi-change" class="index-change">-</div>
            </div>
            <div class="index-card">
                <div class="index-name">KOSDAQ</div>
                <div id="kosdaq-price" class="index-value">-</div>
                <div id="kosdaq-change" class="index-change">-</div>
            </div>
            <div class="index-card">
                <div class="index-name">USD/KRW</div>
                <div id="exchange-price" class="index-value">-</div>
                <div class="index-change" style="color: #666;">
                    <span id="exchange-status" style="font-size: 12px; color: green;">â— Live</span>
                </div>
            </div>
        </section>
        
        <div class="dashboard-grid">    
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">
                        ğŸ”¥ ì‹¤ì‹œê°„ ë­í‚¹ 
                        <span id="rankModeLabel" style="font-size:12px; color:#f55; font-weight:bold; margin-left:4px;">
                            ê¸‰ìƒìŠ¹
                        </span>
                        <span id="rankUpdateTime" style="font-size: 12px; color: #888; font-weight: normal; margin-left: 10px;"></span>
                    </div>
                    
                    <div style="display:flex; align-items:center;">
                        <button id="btnRising" class="more-link2" onclick="setRankMode('rising')">ê¸‰ìƒìŠ¹</button>
                        <button id="btnFalling" class="more-link2" onclick="setRankMode('falling')">ê¸‰í•˜ë½</button>
                        <span class="more-link" onclick="openModal()" style="cursor:pointer; margin-left:8px; font-size:13px;">ë”ë³´ê¸° ></span>
                    </div>
                </div>
            
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th width="50">ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th style="text-align: right;">í˜„ì¬ê°€</th>
                            <th style="text-align: right;">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="rankingList"></tbody>
                </table>
            </div>
            
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">â­ ë‚˜ì˜ ê´€ì‹¬ ì¢…ëª©</div>
                    <div class="more-link" onclick="openManageModal()" style="cursor: pointer;">ê´€ë¦¬ ></div>
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©ëª…</th>
                            <th style="text-align: right;">í˜„ì¬ê°€</th>
                            <th style="text-align: right;">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="watchlist"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="rankModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ”¥ ì‹¤ì‹œê°„ ê¸‰ìƒìŠ¹ Top 30</h3>
                <span class="close-btn" onclick="closeModal()">Ã—</span>
            </div>
            <div class="modal-body">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th width="60" class="text-center">ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th class="text-right">í˜„ì¬ê°€</th>
                            <th class="text-right">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="rankingListFull">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="manageModal" class="modal-overlay">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header">
                <h3>ğŸ› ï¸ ê´€ì‹¬ì¢…ëª© ê´€ë¦¬</h3>
                <span class="close-btn" onclick="closeManageModal()">Ã—</span>
            </div>
            <div class="modal-body">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th style="padding-left:20px;">ì¢…ëª©ëª…</th>
                            <th width="80" class="text-center">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="manageList">
                        </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn-close-modal" onclick="closeManageModal()" style="width:100%;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        const APPROVAL_KEY = /*[[${approvalKey}]]*/ null;
        const WS_URL = /*[[${wsUrl}]]*/ ""; 

        // 15ë¶„ ê°„ê²© (ms)
        const UPDATE_INTERVAL = 15 * 60 * 1000; 
        let ws;
        let rankInterval;
        let currentRankMode = 'rising';

        document.addEventListener('DOMContentLoaded', function() {
            // 1. ì´ˆê¸° ë°ì´í„° ë¡œë”©
            loadInitialIndices(); 
            loadWatchlist();
            updateExchangeRate();
            setRankMode('rising'); // ì²˜ìŒì€ ê¸‰ìƒìŠ¹
            
            // 2. ì›¹ì†Œì¼“ ì—°ê²° (ì¥ ìš´ì˜ ì‹œê°„ ì²´í¬)
            if (isMarketOpen()) {
                if (APPROVAL_KEY) connectWebSocket();
                else console.log("ì›¹ì†Œì¼“ í‚¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            } else {
                console.log("ğŸŒ™ í˜„ì¬ëŠ” ì¥ ë§ˆê° ì‹œê°„ì…ë‹ˆë‹¤. ì›¹ì†Œì¼“ ë¯¸ì—°ê²°.");
            }
            
            // 3. ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
            setupSearch();

            // 4. ë­í‚¹ ìë™ ì—…ë°ì´íŠ¸
            rankInterval = setInterval(() => {
                console.log("â° ë­í‚¹ ì—…ë°ì´íŠ¸ ì£¼ê¸° ë„ë‹¬");
                loadRankByMode();
            }, UPDATE_INTERVAL);
        });

        // ---------------------------------------------------------
        // ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ---------------------------------------------------------

        // ì°¨íŠ¸ í˜ì´ì§€ ì´ë™
        function moveToChart(code, name) {
            if (!code) return;
            localStorage.setItem('selectedCode', code);
            localStorage.setItem('selectedName', name);
            window.location.href = '/chart';
        }

        // ëª¨ë‹¬ ì—´ê¸° (ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì ìš©)
        function openAnyModal(modalId) {
            const modal = document.getElementById(modalId);
            if(!modal) return;
            
            const body = modal.querySelector('.modal-body');
            
            if(body) {
            	body.scrollTop = 0;
            	body.scrollTo(0,0);
            }
            
            modal.style.display = 'flex';
            
            setTimeout(() => {
				modal.classList.add('show');
				
            	if(body) {
					body.scrollTop=0;
					body.scrollTo(0,0);
            	}
            }, 10);
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeAnyModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        // ---------------------------------------------------------
        // ë°ì´í„° ë¡œë”© ë¡œì§
        // ---------------------------------------------------------

        function loadRankByMode() {
            const url = (currentRankMode === 'rising') ? '/api/rank/rising' : '/api/rank/falling';
        
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data || data.length === 0) return;
                    
                    // Top 5 (ëŒ€ì‹œë³´ë“œ)
                    renderTable('rankingList', data.slice(0, 5), true);
                    
                    // Top 30 (ëª¨ë‹¬ìš© ë°ì´í„° ì¤€ë¹„ - ì—´ë¦´ ë•Œ ë Œë”ë§í•˜ë„ë¡ ì €ì¥í•´ë‘ê±°ë‚˜ ì—¬ê¸°ì„œ ë¯¸ë¦¬ ë Œë”ë§)
                    // ì—¬ê¸°ì„œëŠ” ë¯¸ë¦¬ ë Œë”ë§
                    const fullBody = document.getElementById('rankingListFull');
                    if(fullBody) renderTable('rankingListFull', data.slice(0, 30), true);
        
                    // ì‹œê°„ í‘œì‹œ
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    const timeEl = document.getElementById('rankUpdateTime');
                    if(timeEl) {
                        timeEl.innerText = `(${timeStr} ê¸°ì¤€)`;
                    }
                })
                .catch(err => console.error("ë­í‚¹ ë¡œë”© ì‹¤íŒ¨:", err));
        }
        
        function loadWatchlist() {
            fetch('/api/watchlist')
                .then(res => {
                    if (res.status === 401) return null; 
                    return res.json();
                })
                .then(data => {
                    if (data) renderTable('watchlist', data, false);
                    else document.getElementById('watchlist').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</td></tr>';
                })
                .catch(err => console.error("ê´€ì‹¬ì¢…ëª© ë¡œë”© ì‹¤íŒ¨:", err));
        }

        // í…Œì´ë¸” ë Œë”ë§ (ê³µí†µ)
        function renderTable(elementId, data, showRank) {
            const tbody = document.getElementById(elementId);
            if(!tbody) return;
            tbody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.style.cursor = "pointer"; 
                row.onclick = () => moveToChart(item.code, item.name);

                // ìˆ«ì í¬ë§·íŒ…
                let rawPrice = String(item.price || "0").replace(/,/g, ''); 
                let priceVal = parseFloat(rawPrice);
                
                let rawRate = String(item.rate || item.changeRate || "0");
                let rateVal = parseFloat(rawRate);
                
                const colorClass = rateVal > 0 ? 'up' : (rateVal < 0 ? 'down' : '');
                const sign = rateVal > 0 ? '+' : '';

                // ìˆœìœ„ ë±ƒì§€
                const rankHtml = showRank ? 
                    `<td class="text-center"><span class="rank-badge ${index < 3 ? 'rank-'+(index+1) : ''}">${index + 1}</span></td>` : '';

                row.innerHTML = `
                    ${rankHtml}
                    <td>
                        <span class="stock-name">${item.name}</span>
                        <span class="stock-code">${item.code}</span>
                    </td>
                    <td class="text-right" style="font-weight: 500;">${priceVal.toLocaleString()}</td>
                    <td class="text-right ${colorClass}">
                        ${sign}${rateVal.toFixed(2)}%
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ëª¨ë“œ ì „í™˜
        function setRankMode(mode) {
            currentRankMode = mode;
            const label = document.getElementById('rankModeLabel');
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í™œì„±í™” (ì„ íƒì )
            document.getElementById('btnRising').style.fontWeight = mode === 'rising' ? 'bold' : 'normal';
            document.getElementById('btnFalling').style.fontWeight = mode === 'falling' ? 'bold' : 'normal';

            if (mode === 'rising') {
                label.textContent = 'ê¸‰ìƒìŠ¹';
                label.style.color = '#f55';
            } else {
                label.textContent = 'ê¸‰í•˜ë½';
                label.style.color = '#007bff';
            }
            loadRankByMode();
        }

        // ---------------------------------------------------------
        // ëª¨ë‹¬ ê´€ë ¨ ê¸°ëŠ¥
        // ---------------------------------------------------------

        // 1. ë­í‚¹ ë”ë³´ê¸° ëª¨ë‹¬
        function openModal() {
            const title = document.querySelector('#rankModal h3');
            
            if (title) {
                title.textContent = currentRankMode === 'rising' ? 'ğŸ”¥ ì‹¤ì‹œê°„ ê¸‰ìƒìŠ¹ Top 30' : 'ğŸ“‰ ì‹¤ì‹œê°„ ê¸‰í•˜ë½ Top 30';
            }
            
            openAnyModal('rankModal');
        }
        
        function closeModal() { closeAnyModal('rankModal'); }

        // 2. ê´€ì‹¬ì¢…ëª© ê´€ë¦¬ ëª¨ë‹¬
        function openManageModal() {
            fetch('/api/watchlist')
                .then(res => {
                    if (res.status === 401) {
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        return null;
                    }
                    return res.json();
                })
                .then(data => {
                    if (data) renderManageList(data);
                    openAnyModal('manageModal');
                })
                .catch(err => console.error("ê´€ë¦¬ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err));
        }
        function closeManageModal() { closeAnyModal('manageModal'); }

        // ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderManageList(data) {
            const tbody = document.getElementById('manageList');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; color:#999;">ë“±ë¡ëœ ê´€ì‹¬ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                // ê´€ë¦¬ ëª©ë¡ì—ì„œëŠ” í´ë¦­ ì‹œ ì°¨íŠ¸ ì´ë™ ì•ˆ í•¨ (ì‚­ì œ ë²„íŠ¼ ì˜¤ë™ì‘ ë°©ì§€)
                row.innerHTML = `
                    <td style="padding-left:20px;">
                        <span class="stock-name" style="font-weight:bold;">${item.name}</span>
                        <span class="stock-code" style="color:#888; font-size:12px; margin-left:5px;">${item.code}</span>
                    </td>
                    <td class="text-center">
                        <button class="btn-delete-sm" onclick="deleteItem('${item.code}', '${item.name}')">ì‚­ì œ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteItem(code, name) {
            if (!confirm(`'${name}' ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            fetch(`/api/watchlist/${code}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) {
                    openManageModal(); // ëª©ë¡ ê°±ì‹ 
                    loadWatchlist();   // ë©”ì¸í™”ë©´ ê°±ì‹ 
                } else alert("ì‚­ì œ ì‹¤íŒ¨");
            });
        }

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ë‹«ê¸° ì´ë²¤íŠ¸ ì—°ê²°
        document.getElementById('rankModal').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal(); });
        document.getElementById('manageModal').addEventListener('click', e => { if(e.target===e.currentTarget) closeManageModal(); });

        // ---------------------------------------------------------
        // ê¸°íƒ€ ê¸°ëŠ¥ (ì§€ìˆ˜, ê²€ìƒ‰, ì›¹ì†Œì¼“) - ê¸°ì¡´ ë¡œì§ ìœ ì§€
        // ---------------------------------------------------------
        
        function loadInitialIndices() {
             fetch('/api/market/indices') 
                .then(res => res.json())
                .then(data => {
                    if(data.kospi) updateIndexUI("kospi", data.kospi.price, data.kospi.sign, data.kospi.change, data.kospi.rate);
                    if(data.kosdaq) updateIndexUI("kosdaq", data.kosdaq.price, data.kosdaq.sign, data.kosdaq.change, data.kosdaq.rate);
                })
                .catch(err => console.warn("ì´ˆê¸° ì§€ìˆ˜ ë¡œë”© ì‹¤íŒ¨:", err));
        }

        function updateExchangeRate() {
            fetch('/api/market/exchange-rate')
                .then(res => res.text())
                .then(text => {
                    if (!text) return;
                    const rate = JSON.parse(text);
                    const el = document.getElementById('exchange-price');
                    if (el && rate) {
                        el.innerText = parseFloat(rate).toLocaleString() + " ì›";
                        el.className = "index-value flat"; 
                    }
                })
                .catch(err => console.error("í™˜ìœ¨ ì‹¤íŒ¨:", err));
        }

        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResult = document.getElementById('searchResult');

            searchInput.addEventListener('keyup', function() {
                const keyword = this.value.trim();
                if (keyword.length < 1) { searchResult.style.display = 'none'; return; }

                fetch(`/api/stock/search?keyword=${keyword}`)
                    .then(res => res.json())
                    .then(list => {
                        searchResult.innerHTML = '';
                        if (list.length > 0) {
                            searchResult.style.display = 'block';
                            list.forEach(stock => {
                                const li = document.createElement('li');
                                li.textContent = `${stock.name} (${stock.code})`;
                                li.onclick = () => moveToChart(stock.code, stock.name);
                                searchResult.appendChild(li);
                            });
                        } else {
                            searchResult.style.display = 'none';
                        }
                    });
            });
            document.addEventListener('click', e => {
                if (!searchInput.contains(e.target) && !searchResult.contains(e.target)) searchResult.style.display = 'none';
            });
        }

        function connectWebSocket() {
            if (!WS_URL) return;
            ws = new WebSocket(WS_URL);
            ws.onopen = function() {
                console.log("âœ… WebSocket ì—°ê²°ë¨");
                sendSubscribe("0001"); sendSubscribe("1001");
            };
            ws.onmessage = function(evt) {
                const rawData = evt.data;
                if (rawData.startsWith("0") || rawData.startsWith("1")) parseAndDisplay(rawData);
            };
            ws.onclose = function() { setTimeout(connectWebSocket, 3000); };
        }

        function sendSubscribe(code) {
            const req = {
                "header": { "approval_key": APPROVAL_KEY, "custtype": "P", "tr_type": "1", "content-type": "utf-8" },
                "body": { "input": { "tr_id": "H0UPCNT0", "tr_key": code } }
            };
            ws.send(JSON.stringify(req));
        }

        function parseAndDisplay(data) {
            const parts = data.split('|');
            if (parts.length < 4) return;
            const values = parts[3].split('^');
            if (values.length < 10) return; 

            const code = values[0];
            const price = parseFloat(values[2]).toFixed(2);
            const sign = values[3];
            const change = parseFloat(values[4]).toFixed(2);
            const rate = parseFloat(values[9]).toFixed(2);

            let targetId = (code === "0001") ? "kospi" : (code === "1001" ? "kosdaq" : "");
            if(targetId) updateIndexUI(targetId, price, sign, change, rate);
        }
        
        function updateIndexUI(targetId, price, sign, change, rate) {
            const priceEl = document.getElementById(targetId + "-price");
            const changeEl = document.getElementById(targetId + "-change");
            if (!priceEl || !changeEl) return;

            let colorClass = "flat";
            let signIcon = "";
            
            if (sign === "1" || sign === "2" || parseFloat(change) > 0) { 
                colorClass = "up"; signIcon = "â–²"; 
            } else if (sign === "4" || sign === "5" || parseFloat(change) < 0) { 
                colorClass = "down"; signIcon = "â–¼"; 
            }
            
            const formattedPrice = parseFloat(price).toLocaleString('ko-KR', {
                minimumFractionDigits: 2, maximumFractionDigits: 2
            });

            priceEl.innerText = formattedPrice;
            priceEl.className = "index-value " + colorClass;
            changeEl.innerText = `${signIcon} ${change} (${rate}%)`;
            changeEl.className = "index-change " + colorClass;
            
            priceEl.style.opacity = 0.5;
            setTimeout(() => priceEl.style.opacity = 1, 200);
        }

        function isMarketOpen() {
            const now = new Date();
            const day = now.getDay(); 
            const time = now.getHours() * 100 + now.getMinutes();
            if (day === 0 || day === 6) return false;
            if (time >= 900 && time <= 1540) return true;
            return false;
        }
    </script>
</body>
</html>