<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>StockSight - ëŒ€ì‹œë³´ë“œ</title>
    <link type="text/css" th:href="@{/css/chart.css}" rel="stylesheet">
    <link type="text/css" th:href="@{/css/main.css}" rel="stylesheet">
</head>
<body>

    <header>
        <div class="header-content">
            <div class="logo"><a href="/">Algo-View</a></div>
            <nav class="nav-menu">
                <a href="/">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/chart">ì°¨íŠ¸ ë¶„ì„</a>
                <a href="#">ë°±í…ŒìŠ¤íŠ¸</a>
                <a href="/portfolio">í¬íŠ¸í´ë¦¬ì˜¤</a>
            </nav>
            <div class="user-actions">
                <button sec:authorize="isAnonymous()" class="btn-login" onclick="location.href='/user/login'">ë¡œê·¸ì¸</button>
                <th:block sec:authorize="isAuthenticated()">
                    <span class="user-info"><span sec:authentication="name">User</span>ë‹˜</span>
                    <button class="btn-logout" onclick="location.href='/user/logout'">ë¡œê·¸ì•„ì›ƒ</button>
                </th:block>
            </div>
        </div>
    </header>

    <div class="wrapper">
        <section class="hero-section">
            <div class="hero-title">ì–´ë–¤ ì¢…ëª©ì„ ë¶„ì„í•´ ë“œë¦´ê¹Œìš”?</div>
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì‚¼ì„±ì „ì)" autocomplete="off">
                <ul id="searchResult"></ul>
            </div>
        </section>

        <section class="market-indices">
            <div class="index-card">
                <div class="index-name">KOSPI</div>
                <div id="kospi-price" class="index-value">-</div>
                <div id="kospi-change" class="index-change">-</div>
            </div>
            <div class="index-card">
                <div class="index-name">KOSDAQ</div>
                <div id="kosdaq-price" class="index-value">-</div>
                <div id="kosdaq-change" class="index-change">-</div>
            </div>
            <div class="index-card">
                <div class="index-name">USD/KRW</div>
                <div id="exchange-price" class="index-value">-</div>
                <div class="index-change" style="color: #666;">
                    <span id="exchange-status" style="font-size: 12px; color: green;">â— Live</span>
                </div>
            </div>
        </section>

        <div class="dashboard-grid">
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">
                        ğŸ”¥ ì‹¤ì‹œê°„ ê¸‰ìƒìŠ¹ TOP 5 
                        <span id="rankUpdateTime" style="font-size: 12px; color: #888; font-weight: normal; margin-left: 10px;"></span>
                    </div>
                    <div class="more-link" onclick="openModal()" style="cursor: pointer;">ë”ë³´ê¸° ></div>
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th width="50">ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th style="text-align: right;">í˜„ì¬ê°€</th>
                            <th style="text-align: right;">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="rankingList">
                        </tbody>
                </table>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">â­ ë‚˜ì˜ ê´€ì‹¬ ì¢…ëª©</div>
                    <div class="more-link" onclick="openManageModal()" style="cursor: pointer;">ê´€ë¦¬ ></div>
                    
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©ëª…</th>
                            <th style="text-align: right;">í˜„ì¬ê°€</th>
                            <th style="text-align: right;">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="watchlist">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
	
    <div id="rankModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ”¥ ì‹¤ì‹œê°„ ê¸‰ìƒìŠ¹ Top 30</h3>
                <span class="close-btn" onclick="closeModal()">Ã—</span>
            </div>
            <div class="modal-body">
                <table class="stock-table" style="border: none;">
                    <thead>
                        <tr>
                            <th width="60" style="padding-left: 20px;">ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th style="text-align: right;">í˜„ì¬ê°€</th>
                            <th style="text-align: right; padding-right: 20px;">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="rankingListFull">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="manageModal" class="modal-overlay">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header">
                <h3>ğŸ› ï¸ ê´€ì‹¬ì¢…ëª© ê´€ë¦¬</h3>
                <span class="close-btn" onclick="closeManageModal()">Ã—</span>
            </div>
            <div class="modal-body">
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©ëª…</th>
                            <th width="80" style="text-align: center;">ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="manageList">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        const APPROVAL_KEY = /*[[${approvalKey}]]*/ null;
        const WS_URL = /*[[${wsUrl}]]*/ ""; 

        // 15ë¶„ ê°„ê²© (ms)
        const UPDATE_INTERVAL = 15 * 60 * 1000; 
        let ws;
        let rankInterval;

        document.addEventListener('DOMContentLoaded', function() {
            // 1. ì´ˆê¸° ë°ì´í„° ë¡œë”©
            loadInitialIndices(); 
            loadWatchlist();
            updateExchangeRate();
            loadRealRanking();

            // 2. ì›¹ì†Œì¼“ ì—°ê²°
            if (APPROVAL_KEY) connectWebSocket();
            else console.error("â›” WebSocket ì ‘ì†í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            // 3. ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
            setupSearch();

            // 4. ë­í‚¹ ìë™ ì—…ë°ì´íŠ¸ (15ë¶„ ì£¼ê¸°)
            rankInterval = setInterval(() => {
                console.log("â° ë­í‚¹ ì—…ë°ì´íŠ¸ ì£¼ê¸° ë„ë‹¬");
                loadRealRanking();
            }, UPDATE_INTERVAL);
        });

        // [í•µì‹¬] ì°¨íŠ¸ í˜ì´ì§€ ì´ë™ ê³µí†µ í•¨ìˆ˜
        // ê²€ìƒ‰, ë­í‚¹, ê´€ì‹¬ì¢…ëª© ì–´ë””ì„œë“  ì´ í•¨ìˆ˜ í•˜ë‚˜ë§Œ ì“°ë©´ ë©ë‹ˆë‹¤.
        function moveToChart(code, name) {
            if (!code) return;
            
            console.log(`ì°¨íŠ¸ ì´ë™: ${name} (${code})`);
            
            // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì°¨íŠ¸ í˜ì´ì§€ì—ì„œ êº¼ë‚´ ì”€)
            localStorage.setItem('selectedCode', code);
            localStorage.setItem('selectedName', name);
            
            // 2. í˜ì´ì§€ ì´ë™
            window.location.href = '/chart';
        }

        // ---------------------------------------------------------
        // ë°ì´í„° ë¡œë”© í•¨ìˆ˜ë“¤
        // ---------------------------------------------------------

        function loadRealRanking() {
            fetch('/api/rank/rising')
                .then(res => res.json())
                .then(data => {
                    if (!data || data.length === 0) return;
                    renderTable('rankingList', data.slice(0, 5), true); // ëŒ€ì‹œë³´ë“œ
                    renderTable('rankingListFull', data, true);         // ëª¨ë‹¬
                    
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    const timeEl = document.getElementById('rankUpdateTime');
                    if(timeEl) timeEl.innerText = `(${timeStr} ê¸°ì¤€)`;
                })
                .catch(err => console.error("ë­í‚¹ ë¡œë”© ì‹¤íŒ¨:", err));
        }
        
        function loadWatchlist() {
            fetch('/api/watchlist')
                .then(res => {
                    if (res.status === 401) return null; 
                    return res.json();
                })
                .then(data => {
                    if (data) renderTable('watchlist', data, false);
                    else document.getElementById('watchlist').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</td></tr>';
                })
                .catch(err => console.error("ê´€ì‹¬ì¢…ëª© ë¡œë”© ì‹¤íŒ¨:", err));
        }

        // âœ… [ìˆ˜ì •] í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ (í´ë¦­ ì´ë²¤íŠ¸ ì ìš©)
        function renderTable(elementId, data, showRank) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ í´ë¦­ ê°€ëŠ¥í•˜ë‹¤ëŠ” í‘œì‹œ
                row.style.cursor = "pointer"; 
                
                // í´ë¦­ ì‹œ ê³µí†µ í•¨ìˆ˜ í˜¸ì¶œ
                row.onclick = () => moveToChart(item.code, item.name);

                // ë°ì´í„° ì•ˆì „ ì²˜ë¦¬
                let rawPrice = String(item.price || "0").replace(/,/g, ''); 
                let priceVal = parseFloat(rawPrice);
                
                let rawRate = String(item.rate || item.changeRate || "0");
                let rateVal = parseFloat(rawRate);
                
                const colorClass = rateVal > 0 ? 'up' : (rateVal < 0 ? 'down' : '');
                const sign = rateVal > 0 ? '+' : '';

                // ìˆœìœ„ í‘œì‹œ ì—¬ë¶€
                const rankClass = index < 3 ? `rank-${index+1}` : '';
                const rankHtml = showRank ? `<td><span class="rank-badge ${rankClass}">${index + 1}</span></td>` : '';

                row.innerHTML = `
                    ${rankHtml}
                    <td>
                        <span class="stock-name">${item.name}</span>
                        <span class="stock-code">${item.code}</span>
                    </td>
                    <td style="text-align: right; font-weight: 500;">${priceVal.toLocaleString()}</td>
                    <td style="text-align: right;" class="${colorClass}">
                        ${sign}${rateVal.toFixed(2)}%
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResult = document.getElementById('searchResult');

            searchInput.addEventListener('keyup', function() {
                const keyword = this.value.trim();
                if (keyword.length < 1) { searchResult.style.display = 'none'; return; }

                fetch(`/api/stock/search?keyword=${keyword}`)
                    .then(res => res.json())
                    .then(list => {
                        searchResult.innerHTML = '';
                        if (list.length > 0) {
                            searchResult.style.display = 'block';
                            list.forEach(stock => {
                                const li = document.createElement('li');
                                li.textContent = `${stock.name} (${stock.code})`;
                                
                                // âœ… [ìˆ˜ì •] ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œì—ë„ ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
                                li.onclick = () => moveToChart(stock.code, stock.name);
                                
                                searchResult.appendChild(li);
                            });
                        } else {
                            searchResult.style.display = 'none';
                        }
                    });
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResult.contains(e.target)) {
                    searchResult.style.display = 'none';
                }
            });
        }
        
        function loadInitialIndices() {
             fetch('/api/market/indices') 
                .then(res => res.json())
                .then(data => {
                    if(data.kospi) updateIndexUI("kospi", data.kospi.price, data.kospi.sign, data.kospi.change, data.kospi.rate);
                    if(data.kosdaq) updateIndexUI("kosdaq", data.kosdaq.price, data.kosdaq.sign, data.kosdaq.change, data.kosdaq.rate);
                })
                .catch(err => console.warn("ì´ˆê¸° ì§€ìˆ˜ ë¡œë”© ì‹¤íŒ¨:", err));
        }

        function updateExchangeRate() {
            fetch('/api/market/exchange-rate')
                .then(res => res.text())
                .then(text => {
                    if (!text) return;
                    const rate = JSON.parse(text);
                    if (rate) {
                        const el = document.getElementById('exchange-price');
                        if (el) {
                            el.innerText = parseFloat(rate).toLocaleString() + " ì›";
                            el.className = "index-value flat"; 
                        }
                    }
                })
                .catch(err => console.error("í™˜ìœ¨ ë¡œë”© ì‹¤íŒ¨:", err));
        }
        
        // --- WebSocket ê´€ë ¨ ---
        function connectWebSocket() {
            if (!WS_URL) return;
            ws = new WebSocket(WS_URL);

            ws.onopen = function() {
                console.log("âœ… WebSocket ì—°ê²°ë¨");
                sendSubscribe("0001"); 
                sendSubscribe("1001");
            };
            ws.onmessage = function(evt) {
                const rawData = evt.data;
                if (rawData.startsWith("0") || rawData.startsWith("1")) parseAndDisplay(rawData);
            };
            ws.onclose = function() { setTimeout(connectWebSocket, 3000); };
        }

        function sendSubscribe(code) {
            const req = {
                "header": { "approval_key": APPROVAL_KEY, "custtype": "P", "tr_type": "1", "content-type": "utf-8" },
                "body": { "input": { "tr_id": "H0UPCNT0", "tr_key": code } }
            };
            ws.send(JSON.stringify(req));
        }

        function parseAndDisplay(data) {
            const parts = data.split('|');
            if (parts.length < 4) return;
            const values = parts[3].split('^');
            if (values.length < 10) return; 

            const code = values[0];
            const price = parseFloat(values[2]).toFixed(2);
            const sign = values[3];
            const change = parseFloat(values[4]).toFixed(2);
            const rate = parseFloat(values[9]).toFixed(2);

            let targetId = (code === "0001") ? "kospi" : (code === "1001" ? "kosdaq" : "");
            if(targetId) updateIndexUI(targetId, price, sign, change, rate);
        }
        
        function updateIndexUI(targetId, price, sign, change, rate) {
            const priceEl = document.getElementById(targetId + "-price");
            const changeEl = document.getElementById(targetId + "-change");
            if (!priceEl || !changeEl) return;

            let colorClass = "flat";
            let signIcon = "";
            
            if (sign === "1" || sign === "2" || parseFloat(change) > 0) { 
                colorClass = "up"; signIcon = "â–²"; 
            } else if (sign === "4" || sign === "5" || parseFloat(change) < 0) { 
                colorClass = "down"; signIcon = "â–¼"; 
            }
            
            // ì²œ ë‹¨ìœ„ ì½¤ë§ˆ í¬ë§·íŒ… ì ìš©
            const formattedPrice = parseFloat(price).toLocaleString('ko-KR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            priceEl.innerText = formattedPrice;
            priceEl.className = "index-value " + colorClass;
            changeEl.innerText = `${signIcon} ${change} (${rate}%)`;
            changeEl.className = "index-change " + colorClass;
            
            priceEl.style.opacity = 0.5;
            setTimeout(() => priceEl.style.opacity = 1, 200);
        }
        
        function openManageModal() {
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('manageModal').style.display = 'flex';
            
            // ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ì¡´ loadWatchlist ë¡œì§ í™œìš©í•˜ë˜, ê´€ë¦¬ ì „ìš© ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ)
            fetch('/api/watchlist')
                .then(res => {
                    if (res.status === 401) {
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
                        closeManageModal();
                        return null;
                    }
                    return res.json();
                })
                .then(data => {
                    if (data) renderManageList(data);
                })
                .catch(err => console.error("ê´€ë¦¬ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err));
        }
        
     	// 2. ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeManageModal() {
            document.getElementById('manageModal').style.display = 'none';
        }

        // 3. ê´€ë¦¬ìš© ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì‚­ì œ ë²„íŠ¼ í¬í•¨)
        function renderManageList(data) {
            const tbody = document.getElementById('manageList');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; color:#999;">ë“±ë¡ëœ ê´€ì‹¬ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="stock-name">${item.name}</span>
                        <span class="stock-code">${item.code}</span>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn-delete" onclick="deleteItem('${item.code}', '${item.name}')">ì‚­ì œ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 4. ì‚­ì œ API í˜¸ì¶œ
        function deleteItem(code, name) {
            if (!confirm(`'${name}' ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            fetch(`/api/watchlist/${code}`, {
                method: 'DELETE'
            })
            .then(res => {
                if (res.ok) {
                    // ì„±ê³µ ì‹œ UI ê°±ì‹ 
                    // 1. ëª¨ë‹¬ ë‚´ ëª©ë¡ ë‹¤ì‹œ ë¡œë”©
                    openManageModal(); 
                    // 2. ëŒ€ì‹œë³´ë“œ ë©”ì¸ ëª©ë¡ë„ ê°±ì‹ 
                    loadWatchlist();   
                } else {
                    alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            })
            .catch(err => console.error("ì‚­ì œ ì˜¤ë¥˜:", err));
        }

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€)
        document.getElementById('manageModal').addEventListener('click', function(e) {
            if (e.target === this) closeManageModal();
        });
        
        function openModal() {
            document.getElementById('rankModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('rankModal').style.display = 'none';
        }
        
        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('rankModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>