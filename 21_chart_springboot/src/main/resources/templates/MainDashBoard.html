<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>StockSight - ëŒ€ì‹œë³´ë“œ</title>
    <link type="text/css" th:href="@{/css/chart.css}" rel="stylesheet">
     <link type="text/css" th:href="@{/css/main.css}" rel="stylesheet">
</head>
<body>

    <!-- í—¤ë” -->
    <header>
        <div class="header-content">
            <div class="logo"><a href="/">Chart Pattern Finder</a></div>
            <nav class="nav-menu">
                <a href="/">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/chart">ì°¨íŠ¸ ë¶„ì„</a>
                <a href="#">ë°±í…ŒìŠ¤íŠ¸</a> <!-- ì¶”í›„ êµ¬í˜„ -->
                <a href="#">í¬íŠ¸í´ë¦¬ì˜¤</a>
            </nav>
            <div class="user-actions">
                <!-- â­ï¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©: sec:authorize ì‚¬ìš© -->
                
                <!-- ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš° -->
                <button sec:authorize="isAnonymous()" class="btn-login" onclick="location.href='/user/login'">ë¡œê·¸ì¸</button>
                
                <!-- ë¡œê·¸ì¸ ëœ ê²½ìš° -->
                <th:block sec:authorize="isAuthenticated()">
                    <!-- ì¸ì¦ ê°ì²´ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° -->
                    <span class="user-info"><span sec:authentication="name">User</span>ë‹˜</span>
                    <button class="btn-logout" onclick="location.href='/user/logout'">ë¡œê·¸ì•„ì›ƒ</button>
                </th:block>
            </div>
        </div>
    </header>

    <div class="wrapper">
        <!-- íˆì–´ë¡œ (ê²€ìƒ‰) -->
        <section class="hero-section">
            <div class="hero-title">ì–´ë–¤ ì¢…ëª©ì„ ë¶„ì„í•´ ë“œë¦´ê¹Œìš”?</div>
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì‚¼ì„±ì „ì)" autocomplete="off">
                <ul id="searchResult"></ul>
            </div>
        </section>

        <!-- ì‹œì¥ ì§€ìˆ˜ (Mock Data) -->
        <section class="market-indices">
            <div class="index-card">
                <div class="index-name">KOSPI</div>
                <!-- ID: kospi-price, kospi-change -->
                <div id="kospi-price" class="index-value">-</div>
                <div id="kospi-change" class="index-change">-</div>
            </div>
            <div class="index-card">
                <div class="index-name">KOSDAQ</div>
                <!-- ID: kosdaq-price, kosdaq-change -->
                <div id="kosdaq-price" class="index-value">-</div>
                <div id="kosdaq-change" class="index-change">-</div>
            </div>
            <div class="index-card">
                <div class="index-name">USD/KRW</div>
                <div id="exchange-price" class="index-value">-</div>
                <div class="index-change" style="color: #666;">
                    <span id="exchange-status" style="font-size: 12px; color: green;">â— Live</span>
                </div>
            </div>
        </section>

        <!-- ë©”ì¸ ì½˜í…ì¸  ê·¸ë¦¬ë“œ (ìˆœìœ„ & ê´€ì‹¬ì¢…ëª©) -->
        <div class="dashboard-grid">
            <!-- ì™¼ìª½: ì‹¤ì‹œê°„ ê¸‰ìƒìŠ¹ -->
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">ğŸ”¥ ì‹¤ì‹œê°„ ê¸‰ìƒìŠ¹ TOP 5</div>
                    <div class="more-link">ë”ë³´ê¸° ></div>
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th width="50">ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th style="text-align: right;">í˜„ì¬ê°€</th>
                            <th style="text-align: right;">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="rankingList">
                        <!-- JSë¡œ ë°ì´í„° ë¡œë”© -->
                    </tbody>
                </table>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ë‚´ ê´€ì‹¬ì¢…ëª© -->
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">â­ ë‚˜ì˜ ê´€ì‹¬ ì¢…ëª©</div>
                    <div class="more-link">ê´€ë¦¬</div>
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©ëª…</th>
                            <th style="text-align: right;">í˜„ì¬ê°€</th>
                            <th style="text-align: right;">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="watchlist">
                        <!-- JSë¡œ ë°ì´í„° ë¡œë”© -->
                    </tbody>
                </table>
                <!-- ë¡œê·¸ì¸ ì•ˆë˜ì–´ ìˆì„ ì‹œ -->
                <!-- <div style="text-align: center; padding: 20px; color: #999;">ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</div> -->
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        // 1. ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í‚¤ì™€ URL (Natural Template Syntax ì ìš©)
        // ì£¼ì„ ì²˜ë¦¬ëœ ë¶€ë¶„ì€ Thymeleafê°€ ì²˜ë¦¬í•˜ê³ , 'null'ì´ë‚˜ '""'ëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
        // ì´ë ‡ê²Œ í•˜ë©´ IDEì—ì„œ ë¬¸ë²• ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        const APPROVAL_KEY = /*[[${approvalKey}]]*/ null;
        const WS_URL = /*[[${wsUrl}]]*/ ""; 

        let ws;

        document.addEventListener('DOMContentLoaded', function() {
            // ê¸°ì¡´ í…Œì´ë¸” ë Œë”ë§ ë“± ...
            
            // â­ï¸ ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘ (í‚¤ê°€ ìˆì„ ë•Œë§Œ)
            if (APPROVAL_KEY) {
                connectWebSocket();
            } else {
                console.warn("ì›¹ì†Œì¼“ ì ‘ì†í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì‹œê°„ ì‹œì„¸ ì—°ë™ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.");
            }
            
			loadWatchlist();
            setupSearch();
            
            updateExchangeRate();
            setInterval(updateExchangeRate, 5000); 
        });
        
        function loadWatchlist() {
            fetch('/api/watchlist')
                .then(res => {
                    if (res.status === 401) return null; // ë¹„ë¡œê·¸ì¸ ìƒíƒœ
                    return res.json();
                })
                .then(data => {
                    if (data) {
                        renderTable('watchlist', data, false);
                    } else {
                        document.getElementById('watchlist').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</td></tr>';
                    }
                })
                .catch(err => console.error("ê´€ì‹¬ì¢…ëª© ë¡œë”© ì‹¤íŒ¨:", err));
        }
        
        function updateExchangeRate() {
            fetch('/api/market/exchange-rate')
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Network response was not ok: ' + res.status);
                    }
                    return res.text(); // 1. í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € ë°›ìŒ (ë¹ˆ ê°’ í™•ì¸ìš©)
                })
                .then(text => {
                    if (!text) {
                        console.warn("í™˜ìœ¨ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. (API í˜¸ì¶œ ì‹¤íŒ¨ ê°€ëŠ¥ì„±)");
                        return;
                    }
                    
                    const rate = JSON.parse(text); // 2. JSON íŒŒì‹±
                    // console.log("í™˜ìœ¨ ë°ì´í„° ìˆ˜ì‹ :", rate); // ë””ë²„ê¹…ìš©

                    if (rate) {
                        const el = document.getElementById('exchange-price');
                        if (!el) return;

                        const currentPrice = parseFloat(rate);
                        
                        // ì´ì „ ê°’ê³¼ ë¹„êµí•˜ì—¬ ìƒ‰ìƒ íš¨ê³¼
                        const prevPrice = parseFloat(el.getAttribute('data-prev') || currentPrice);
                        let colorClass = "flat";
                        if (currentPrice > prevPrice) colorClass = "up";
                        else if (currentPrice < prevPrice) colorClass = "down";
                        
                        el.innerText = currentPrice.toLocaleString() + " ì›";
                        el.className = "index-value " + colorClass;
                        el.setAttribute('data-prev', currentPrice);

                        // ê¹œë¹¡ì„ íš¨ê³¼
                        el.style.opacity = 0.5;
                        setTimeout(() => el.style.opacity = 1, 200);
                    }
                })
                .catch(err => console.error("í™˜ìœ¨ ë¡œë”© ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸):", err));
        }

        function connectWebSocket() {
            if (!APPROVAL_KEY) {
                console.error("ì›¹ì†Œì¼“ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            console.log("WebSocket ì—°ê²° ì‹œë„: " + WS_URL);
            ws = new WebSocket(WS_URL);

            ws.onopen = function() {
                console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ!");
                
                // 1. KOSPI êµ¬ë… ìš”ì²­ (0001)
                sendSubscribe("0001"); 
                // 2. KOSDAQ êµ¬ë… ìš”ì²­ (1001)
                sendSubscribe("1001");
            };

            ws.onmessage = function(evt) {
                const rawData = evt.data;
                // ì²« ë°ì´í„°ëŠ” ì•”í˜¸í™”ëœ í‚¤ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¬´ì‹œí•˜ê±°ë‚˜, 0ì´ë‚˜ 1ë¡œ ì‹œì‘í•˜ëŠ” ë°ì´í„°ë§Œ ì²˜ë¦¬
                if (rawData.startsWith("0") || rawData.startsWith("1")) {
                    parseAndDisplay(rawData);
                }
            };

            ws.onclose = function() {
                console.log("WebSocket ì—°ê²° ì¢…ë£Œ. 3ì´ˆ í›„ ì¬ì—°ê²°...");
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(err) {
                console.error("WebSocket ì—ëŸ¬:", err);
            };
        }

        function sendSubscribe(code) {
            // í•œêµ­íˆ¬ìì¦ê¶Œ ì›¹ì†Œì¼“ êµ¬ë… í¬ë§·
            const req = {
                "header": {
                    "approval_key": APPROVAL_KEY,
                    "custtype": "P", // ê°œì¸
                    "tr_type": "1",  // 1: ë“±ë¡(êµ¬ë…), 2: í•´ì œ
                    "content-type": "utf-8"
                },
                "body": {
                    "input": {
                        "tr_id": "H0UPCNT0", // ì‹¤ì‹œê°„ ì§€ìˆ˜ ì²´ê²°ê°€ TR ID
                        "tr_key": code       // 0001(ì½”ìŠ¤í”¼), 1001(ì½”ìŠ¤ë‹¥)
                    }
                }
            };
            ws.send(JSON.stringify(req));
        }

        function parseAndDisplay(data) {
            // ë°ì´í„° í¬ë§·: 0|H0UPCNT0|001|0001^1234.56^12.34^1^1.23^...
            // êµ¬ë¶„ì | ë¡œ ë‚˜ëˆ”
            const parts = data.split('|');
            if (parts.length < 4) return;

            // parts[3]ì— ì‹¤ì œ ë°ì´í„°ê°€ ë“¤ì–´ìˆìŒ (êµ¬ë¶„ì ^)
            const content = parts[3];
            const values = content.split('^');

         	// H0UPCNT0 (ì‹¤ì‹œê°„ ì§€ìˆ˜) ë°ì´í„° ìˆœì„œ ìˆ˜ì •:
            // [0]: ì¢…ëª©ì½”ë“œ (0001 or 1001)
            // [1]: ì²´ê²°ì‹œê°„ (HHMMSS) -> ê¸°ì¡´ ì½”ë“œì—ì„œ ê°€ê²©ìœ¼ë¡œ ì˜¤ì¸í•œ ë¶€ë¶„
            // [2]: í˜„ì¬ê°€ (ì§€ìˆ˜)
            // [3]: ì „ì¼ëŒ€ë¹„ ë¶€í˜¸ (1:ìƒí•œ, 2:ìƒìŠ¹, 3:ë³´í•©, 4:í•˜í•œ, 5:í•˜ë½)
            // [4]: ì „ì¼ëŒ€ë¹„ (ê°’)
            // [9]: ë“±ë½ë¥  (%)
            
            const code = values[0];
            const price = parseFloat(values[2]).toFixed(2);
            const sign = values[3]; 
            const change = parseFloat(values[4]).toFixed(2);
            const rate = parseFloat(values[9]).toFixed(2);

            // UI ì—…ë°ì´íŠ¸
            let targetId = "";
            if (code === "0001") targetId = "kospi";
            else if (code === "1001") targetId = "kosdaq";
            else return;

            const priceEl = document.getElementById(targetId + "-price");
            const changeEl = document.getElementById(targetId + "-change");

            if (priceEl && changeEl) {
                // ìƒ‰ìƒ ê²°ì •
                let colorClass = "flat";
                let signIcon = "";
                if (sign === "1" || sign === "2") { colorClass = "up"; signIcon = "â–²"; }
                else if (sign === "4" || sign === "5") { colorClass = "down"; signIcon = "â–¼"; }

                // ê°’ ë„£ê¸°
                priceEl.innerText = price;
                priceEl.className = "index-value " + colorClass;
                
                changeEl.innerText = `${signIcon} ${change} (${rate}%)`;
                changeEl.className = "index-change " + colorClass;
                
                // ê¹œë¹¡ì„ íš¨ê³¼ (ì—…ë°ì´íŠ¸ ì‹œê°ì  í”¼ë“œë°±)
                priceEl.style.opacity = 0.5;
                setTimeout(() => priceEl.style.opacity = 1, 200);
            }
        }
    </script>

    <script>
        // --- ë”ë¯¸ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œ APIì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨) ---
        const mockRankings = [
            { code: '005930', name: 'ì‚¼ì„±ì „ì', price: 78000, change: 1.5 },
            { code: '000660', name: 'SKí•˜ì´ë‹‰ìŠ¤', price: 142000, change: 3.2 },
            { code: '035420', name: 'NAVER', price: 205000, change: -0.5 },
            { code: '035720', name: 'ì¹´ì¹´ì˜¤', price: 54300, change: -1.2 },
            { code: '005380', name: 'í˜„ëŒ€ì°¨', price: 240500, change: 2.8 }
        ];

        const mockWatchlist = [
            { code: '005930', name: 'ì‚¼ì„±ì „ì', price: 78000, change: 1.5 },
            { code: '035720', name: 'ì¹´ì¹´ì˜¤', price: 54300, change: -1.2 },
            { code: '000270', name: 'ê¸°ì•„', price: 110000, change: 0.8 }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            renderTable('rankingList', mockRankings, true);
            renderTable('watchlist', mockWatchlist, false);
            
            // ê²€ìƒ‰ì°½ ì´ë²¤íŠ¸ ì—°ê²° (ê¸°ì¡´ ì°¨íŠ¸ í˜ì´ì§€ API í™œìš©)
            setupSearch();
        });

        function renderTable(elementId, data, showRank) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const rankClass = index < 3 ? `rank-${index+1}` : '';
                const rankHtml = showRank ? `<td><span class="rank-badge ${rankClass}">${index + 1}</span></td>` : '';
                
                const colorClass = item.change > 0 ? 'up' : (item.change < 0 ? 'down' : '');
                const sign = item.change > 0 ? '+' : '';

                row.innerHTML = `
                    ${rankHtml}
                    <td>
                        <span class="stock-name">${item.name}</span>
                        <span class="stock-code">${item.code}</span>
                    </td>
                    <td style="text-align: right; font-weight: 500;">${item.price.toLocaleString()}</td>
                    <td style="text-align: right;" class="${colorClass}">
                        ${sign}${item.change}%
                    </td>
                `;
                
                // í´ë¦­ ì‹œ ì°¨íŠ¸ í˜ì´ì§€ë¡œ ì´ë™
                row.onclick = () => {
                    window.location.href = `/chart?code=${item.code}`; // (í˜„ì¬ ì°¨íŠ¸ í˜ì´ì§€ê°€ ì½”ë“œ íŒŒë¼ë¯¸í„°ë¥¼ ë°›ë„ë¡ ìˆ˜ì • í•„ìš”)
                    // í˜¹ì€ localStorageì— ì €ì¥í•˜ê³  ì´ë™
                    localStorage.setItem('selectedCode', item.code);
                    localStorage.setItem('selectedName', item.name);
                    window.location.href = '/chart';
                };

                tbody.appendChild(row);
            });
        }

        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResult = document.getElementById('searchResult');

            searchInput.addEventListener('keyup', function() {
                const keyword = this.value.trim();
                if (keyword.length < 1) { searchResult.style.display = 'none'; return; }

                // ê¸°ì¡´ì— ë§Œë“  ê²€ìƒ‰ API í™œìš©
                fetch(`/api/stock/search?keyword=${keyword}`)
                    .then(res => res.json())
                    .then(list => {
                        searchResult.innerHTML = '';
                        if (list.length > 0) {
                            searchResult.style.display = 'block';
                            list.forEach(stock => {
                                const li = document.createElement('li');
                                li.textContent = `${stock.name} (${stock.code})`;
                                li.onclick = () => {
                                    // ì„ íƒ ì‹œ ì°¨íŠ¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ë©´ì„œ ë°ì´í„° ì „ë‹¬
                                    // (ê°„ë‹¨í•˜ê²Œ localStorage ì‚¬ìš©, ì‹¤ì œë¡œëŠ” URL Query Parameter ì¶”ì²œ)
                                    localStorage.setItem('selectedCode', stock.code);
                                    localStorage.setItem('selectedName', stock.name);
                                    window.location.href = '/chart'; 
                                };
                                searchResult.appendChild(li);
                            });
                        } else {
                            searchResult.style.display = 'none';
                        }
                    });
            });
            
            // ì™¸ë¶€ í´ë¦­ ì‹œ ê²€ìƒ‰ì°½ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResult.contains(e.target)) {
                    searchResult.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>