<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <link type="text/css" th:href="@{/css/chart.css}" rel="stylesheet">
    <link type="text/css" th:href="@{/css/main.css}" rel="stylesheet">
    <link type="text/css" th:href="@{/css/portfolio.css}" rel="stylesheet">
    <link rel="icon" type="image/png" th:href="@{/images/logo.png}">
    <title>AlgoView - í¬íŠ¸í´ë¦¬ì˜¤</title>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo"><a href="/">Algo-View</a></div>
            <nav class="nav-menu">
                <a href="/">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/chart">ì°¨íŠ¸ ë¶„ì„</a>
                <a href="/backtest">ë°±í…ŒìŠ¤íŠ¸</a>
                <a href="/portfolio" class="active">í¬íŠ¸í´ë¦¬ì˜¤</a> </nav>
            <div class="user-actions">
                <th:block sec:authorize="isAuthenticated()">
                    <span class="user-info"><span sec:authentication="name">User</span>ë‹˜</span>
                    <button class="btn-logout" onclick="location.href='/user/logout'">ë¡œê·¸ì•„ì›ƒ</button>
                </th:block>
            </div>
        </div>
    </header>

    <div class="wrapper" style="max-width: 1200px; margin: 40px auto;">
        
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-label">ì´ ë§¤ìˆ˜ ê¸ˆì•¡</div>
                <div class="summary-value" id="totalInvested">0 ì›</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">ì´ í‰ê°€ ê¸ˆì•¡</div>
                <div class="summary-value" id="totalValue">0 ì›</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">ì´ í‰ê°€ ì†ìµ</div>
                <div class="summary-value" id="totalProfit">0 ì›</div>
                <div id="totalRate" style="font-size: 14px; margin-top: 5px;">0.00%</div>
            </div>
        </div>

        <div style="overflow: hidden; margin-bottom: 10px;">
            <h2 style="float: left; margin: 0;">ë³´ìœ  ì¢…ëª© í˜„í™©</h2>
            <button class="btn-add" onclick="openAddModal()">+ ì¢…ëª© ì¶”ê°€</button>
        </div>

        <div class="content-card">
            <table class="stock-table pf-table">
                <thead>
                    <tr>
                        <th>ì¢…ëª©ëª…</th>
                        <th>ë³´ìœ ìˆ˜ëŸ‰</th>
                        <th>ë§¤ìˆ˜í‰ë‹¨ê°€</th>
                        <th>í˜„ì¬ê°€</th>
                        <th>í‰ê°€ê¸ˆì•¡</th>
                        <th>í‰ê°€ì†ìµ</th>
                        <th>ìˆ˜ìµë¥ </th>
                        <th style="text-align: center;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="portfolioList">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="addModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’° ë³´ìœ  ì¢…ëª© ì¶”ê°€</h3>
                <span class="close-btn" onclick="closeAddModal()">Ã—</span>
            </div>
            
            <div class="modal-body">
                <label class="form-label">ì¢…ëª© ê²€ìƒ‰</label>
                <div class="input-group">
                    <input type="text" id="pSearchInput" class="form-input" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ì…ë ¥ (ì˜ˆ: ì‚¼ì„±)" onkeyup="if(window.event.keyCode==13){searchStock()}">
                    <button class="btn-search" onclick="searchStock()">ê²€ìƒ‰</button>
                    <ul id="pSearchResult" class="search-results"></ul>
                </div>
                
                <label class="form-label">ì„ íƒëœ ì¢…ëª©</label>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="selectedStockName" class="form-input" readonly placeholder="ìœ„ì—ì„œ ê²€ìƒ‰ í›„ ì„ íƒí•´ì£¼ì„¸ìš”">
                    <input type="hidden" id="selectedStockCode">
                </div>

                <div class="row-group">
                    <div style="flex: 1;">
                        <label class="form-label">ë§¤ìˆ˜ í‰ê· ê°€ (ì›)</label>
                        <input type="number" id="buyPrice" class="form-input" placeholder="0">
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">ë³´ìœ  ìˆ˜ëŸ‰ (ì£¼)</label>
                        <input type="number" id="quantity" class="form-input" placeholder="0">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAddModal()">ì·¨ì†Œ</button>
                <button class="btn-save" onclick="submitPortfolio()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadPortfolio();
        });

        function loadPortfolio() {
            fetch('/api/portfolio')
                .then(res => res.json())
                .then(data => {
                    renderPortfolio(data);
                    calculateSummary(data);
                })
                .catch(err => console.error(err));
        }

        function renderPortfolio(data) {
            const tbody = document.getElementById('portfolioList');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">ë³´ìœ  ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(item => {
                const colorClass = item.profit > 0 ? 'up' : (item.profit < 0 ? 'down' : '');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <span class="stock-name" style="font-weight: bold;">${item.name}</span>
                        <br><span class="stock-code" style="font-size: 12px; color: #888;">${item.code}</span>
                    </td>
                    <td>${item.quantity.toLocaleString()} ì£¼</td>
                    <td>${item.averagePrice.toLocaleString()}</td>
                    <td>${item.currentPrice.toLocaleString()}</td>
                    <td>${item.totalValue.toLocaleString()}</td>
                    <td class="${colorClass}">${item.profit.toLocaleString()}</td>
                    <td class="${colorClass}">${item.profitRate}%</td>
                    <td style="text-align: center;">
                        <button onclick="deletePortfolio(${item.id})" style="color: red; background: none; border: none; cursor: pointer;">ğŸ—‘</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function calculateSummary(data) {
            let tInvested = 0;
            let tValue = 0;

            data.forEach(d => {
                tInvested += d.totalInvested;
                tValue += d.totalValue;
            });

            const tProfit = tValue - tInvested;
            const tRate = tInvested > 0 ? ((tProfit / tInvested) * 100).toFixed(2) : "0.00";
            
            document.getElementById('totalInvested').innerText = tInvested.toLocaleString() + " ì›";
            document.getElementById('totalValue').innerText = tValue.toLocaleString() + " ì›";
            
            const profitEl = document.getElementById('totalProfit');
            profitEl.innerText = tProfit.toLocaleString() + " ì›";
            profitEl.className = "summary-value " + (tProfit > 0 ? 'up' : (tProfit < 0 ? 'down' : ''));
            
            const rateEl = document.getElementById('totalRate');
            rateEl.innerText = tRate + " %";
            rateEl.style.color = tProfit > 0 ? '#e12b2b' : (tProfit < 0 ? '#2b78e1' : '#666');
        }

        // --- ëª¨ë‹¬ ë° ì¶”ê°€ ê¸°ëŠ¥ ---
        function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }
        function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }

        // ì¢…ëª© ê²€ìƒ‰ (ê¸°ì¡´ API í™œìš©)
        function searchStock() {
            const keyword = document.getElementById('pSearchInput').value;
            fetch(`/api/stock/search?keyword=${keyword}`)
                .then(res => res.json())
                .then(list => {
                    const ul = document.getElementById('pSearchResult');
                    ul.innerHTML = '';
                    ul.style.display = 'block';
                    list.forEach(stock => {
                        const li = document.createElement('li');
                        li.innerText = `${stock.name} (${stock.code})`;
                        li.style.padding = '5px';
                        li.style.cursor = 'pointer';
                        li.onclick = () => {
                            document.getElementById('selectedStockName').value = stock.name;
                            document.getElementById('selectedStockCode').value = stock.code;
                            ul.style.display = 'none';
                        };
                        ul.appendChild(li);
                    });
                });
        }

        function submitPortfolio() {
            const code = document.getElementById('selectedStockCode').value;
            const name = document.getElementById('selectedStockName').value;
            const price = document.getElementById('buyPrice').value;
            const quantity = document.getElementById('quantity').value;

            if(!code || !price || !quantity) {
                alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            fetch('/api/portfolio', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `code=${code}&name=${name}&price=${price}&quantity=${quantity}`
            }).then(res => {
                if(res.ok) {
                    closeAddModal();
                    loadPortfolio();
                } else {
                    alert("ì¶”ê°€ ì‹¤íŒ¨");
                }
            });
        }

        function deletePortfolio(id) {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                fetch(`/api/portfolio/${id}`, { method: 'DELETE' })
                    .then(res => {
                        if(res.ok) loadPortfolio();
                    });
            }
        }
    </script>
</body>
</html>